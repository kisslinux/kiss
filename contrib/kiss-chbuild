#!/bin/sh -e
# Create/destroy temporary chroots

log() {
    printf '\033[31;1m->\033[m %s.\n' "$@"
}

cd "${cac_dir:=$KISS_ROOT${XDG_CACHE_HOME:-$HOME/.cache}/kiss}"

[ -f kiss-chroot.tar.xz ] || {
    log "Downloading chroot tarball"

    url=https://github.com/kisslinux/repo/releases/download/1.10.0/
    curl -OL "$url/kiss-chroot.tar.xz.sha256"
    curl -OL "$url/kiss-chroot.tar.xz"

    log "Verifying checksums"

    sha256sum -c < kiss-chroot.tar.xz.sha256 || {
        rm -f kiss-chroot.tar.xz
        log "Checksum verification failed."
        log "Re-run 'kiss-chbuild' to try again."
    }
}

log "Verifying checksums"

sha256sum -c < kiss-chroot.tar.xz.sha256 || {
    rm -f kiss-chroot.tar.xz
    log "Checksum verification failed."
    log "Re-run 'kiss-chbuild' to try again."
    exit 0
}

[ -d kiss-chroot ] || {
    log "Extracting chroot"
    tar xf kiss-chroot.tar.xz
}

log "Creating temporary chroot"
cp -a kiss-chroot "chroot-$$"

log "Installing any arguments"
[ ! "$1" ] || KISS_ROOT=$PWD/chroot-$$ kiss i "$@"

log "Entering chroot"
su -c "kiss-chroot chroot-$$; rm -rf chroot-$$"
